<script>
    import ToastStore from '../stores/toast';
    import SplashStore from '../stores/splash';
    import SettingsStore from '../stores/settings';

    import {flip} from 'svelte/animate';
    import {crossfade} from 'svelte/transition';
    import {quintOut} from 'svelte/easing';

    import ToastComponent from '../components/Toast.svelte';
    import Menu from "../components/Menu.svelte";
    import Footer from "../components/Footer.svelte";
    import {writable} from "svelte/store";
    import {awaitSidecarInit} from "../utils/sidecar";
    import {onMount} from "svelte";
    import Suspense from "../components/Suspense.svelte";
    import OrangeButton from "../components/Input/Button/OrangeButton.svelte";
    import {SidecarWebsocket} from "../utils/http";
    import {process} from "@tauri-apps/api";
    import {appWindow} from '@tauri-apps/api/window';
    import {goto, isActive, url} from "@roxi/routify";


    let urls = [
        {
            "title": "Driver",
            "url": "./driver",
            "children": [
                {
                    "title": "Configuration",
                    "url": "./driver/configuration",
                },
                {
                    "title": "Functions",
                    "url": "./driver/functions"
                }
            ]
        },
        {
            "title": "Firmware",
            "url": "./firmware",
            "children": [
                {
                    "title": "Configuration",
                    "url": "./firmware/configuration"
                },
                {
                    "title": "Update",
                    "url": "./firmware/update"
                }
            ]
        },
        {
            "title": "UI Settings",
            "url": "./settings"
        }
    ];



    
    $: {
        const mapUrls = (item) => {
            Object.keys(item).map((k, i) => {
                item[k] = {...item[k], ...{
                        href: $url(item[k].url),
                        onClick: () => $goto(item[k].url),
                        active: !!$isActive(item[k].url),
                    }};
                if(item[k]?.children) mapUrls(item[k].children);

            });
        }

        mapUrls(urls);

        urls = urls;
    }

    const state = writable({
        sidecar: {
            loading: true,
            success: false,
            process: null,
        },
        visibleToasts: [],
        activeUrl: ''
    });

    const [send, receive] = crossfade({
        duration: d => Math.sqrt(d * 200),

        fallback(node, params) {
            const style = getComputedStyle(node)
            const transform = style.transform === 'none' ? '' : style.transform

            return {
                duration: 600,
                easing: quintOut,
                css: t => `
					transform: ${transform} scale(${t});
					opacity: ${t}
				`
            }
        }
    });

    ToastStore.subscribe(e => {
        //we have received a toast update
        if (e.length > $state.visibleToasts.length) {
            //last toast added
            $state.visibleToasts = [...$state.visibleToasts, [e[e.length - 1].message, e[e.length - 1].severity, Math.random(), ToastComponent]];

            window.setTimeout(() => {
                $state.visibleToasts = $state.visibleToasts.slice(1, $state.visibleToasts.length);
                ToastStore.popToast();

                //success or error timeout length
            }, e[e.length - 1].severity === 2 ? 2000 : 5000);
        }
    });


    let isClosing = false;
    const closeApp = () => {
        if (isClosing) return;
        isClosing = true;
        ToastStore.addToast(ToastStore.severity.WARNING, "SteamVR closed! Closing app...");

        setTimeout(() => {
            appWindow.close();
            process.exit();
        }, 1000);
    }

    const init = async () => {
        try {
            $state.sidecar.loading = true;
            if ($state.sidecar.process) $state.sidecar.process.kill();

            await awaitSidecarInit((child) => $state.sidecar.process = child);

            const sidecarWebsocket = new SidecarWebsocket(() => {
                $state.sidecar.success = true;
                $state.sidecar.loading = false;
            }, (event) => {
                console.log(event.data);
                if (event.data === 'shutdown') closeApp();
            }, (event) => {
                closeApp();
            });

            await appWindow.listen('tauri://close-requested', ({event, payload}) => {
                sidecarWebsocket.send('shutdown');
            })


        } catch (e) {
            console.error(e);
            $state.sidecar.success = false;
            ToastStore.addToast(ToastStore.severity.ERROR, e);
            $state.sidecar.loading = false;
        }
    }

    onMount(init);
</script>

<div class="fixed right-0 top-0 m-5 z-50">
    {#each $state.visibleToasts as [message, severity, id, ToastComponent], index (id)}
        <div in:receive="{{key: id}}"
             out:send="{{key: id}}"
             animate:flip>
            <ToastComponent message={message} severity={severity}/>
        </div>
    {/each}
</div>

<div class="{$SettingsStore[SettingsStore.SETTINGS_OPTION.UI_THEME] === 'dark' ? 'dark' : ''}">

    <div class="font-sans min-h-screen flex flex-col justify-center items-center bg-gray-50 dark:bg-gray-900 overflow-hidden dark:text-gray-300 text-gray-800">
        {#if $SplashStore.length > 0}
            <svelte:component this={$SplashStore[$SplashStore.length-1].component}
                              {...$SplashStore[$SplashStore.length - 1].props}/>
        {:else}
            <Suspense suspense={$state.sidecar.loading} message="Initialising...">
                {#if $state.sidecar.success}
                    <Menu items={urls} bind:activeUrl={$state.activeUrl}/>
                    <div class="flex-grow">
                        <slot/>
                    </div>
                    <Footer/>
                {:else}
                    <div class="h-full w-full flex items-center justify-center">
                        <OrangeButton onClick={init}>Retry Load</OrangeButton>
                    </div>
                {/if}
            </Suspense>
        {/if}
    </div>

</div>

